name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          express-rag-api/package-lock.json
          nextjs-ui/package-lock.json

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache LLM models
      id: cache-models
      uses: actions/cache@v3
      with:
        path: llm-server/models
        key: llm-models-${{ runner.os }}-v1
        restore-keys: |
          llm-models-${{ runner.os }}-

    - name: Download LLM model (if not cached)
      if: steps.cache-models.outputs.cache-hit != 'true'
      run: |
        mkdir -p llm-server/models
        # Uncomment to download a real model
        # wget -O llm-server/models/phi-3-mini.gguf \
        #   https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-gguf/resolve/main/Phi-3-mini-4k-instruct-q4.gguf
        echo "Model download skipped - using mock mode"

    - name: Install Express API dependencies
      working-directory: ./express-rag-api
      run: |
        npm ci

    - name: Install Next.js UI dependencies
      working-directory: ./nextjs-ui
      run: |
        npm ci

    - name: Install Python dependencies
      working-directory: ./llm-server
      run: |
        pip install -r requirements.txt

    - name: Run Express API tests
      working-directory: ./express-rag-api
      run: |
        npm test || echo "Tests not implemented yet"

    - name: Build Docker images
      run: |
        docker-compose build

    - name: Start services
      run: |
        docker-compose up -d
        
    - name: Wait for services to be healthy
      run: |
        echo "Waiting for services to start..."
        sleep 30
        
        # Check LLM server
        for i in {1..10}; do
          if curl -f http://localhost:8000/health; then
            echo "LLM server is healthy"
            break
          fi
          echo "Waiting for LLM server... ($i/10)"
          sleep 5
        done
        
        # Check Express API
        for i in {1..10}; do
          if curl -f http://localhost:3001/health; then
            echo "Express API is healthy"
            break
          fi
          echo "Waiting for Express API... ($i/10)"
          sleep 5
        done

    - name: Run integration tests
      run: |
        # Test LLM server
        curl -f http://localhost:8000/health || exit 1
        
        # Test Express API health
        curl -f http://localhost:3001/health || exit 1
        
        # Test Express API breeds endpoint
        curl -f http://localhost:3001/api/breeds/list || exit 1
        
        # Test RAG endpoint
        curl -X POST http://localhost:3001/api/rag/query \
          -H "Content-Type: application/json" \
          -d '{"question":"What are terrier breeds?"}' \
          || exit 1
        
        echo "All integration tests passed!"

    - name: Show service logs on failure
      if: failure()
      run: |
        echo "=== LLM Server Logs ==="
        docker-compose logs llm-server
        echo "=== Express API Logs ==="
        docker-compose logs express-api
        echo "=== Next.js UI Logs ==="
        docker-compose logs nextjs-ui

    - name: Stop services
      if: always()
      run: |
        docker-compose down

  deploy:
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy notification
      run: |
        echo "Deployment would happen here"
        echo "This could push to a container registry or deploy to a cloud provider"
